#########  CHECK FOR ROOT ######### 
f_checkroot(){
perm=$(id|cut -b 5)

if [ "$perm" != "0" ];then echo "This requires root! Type: su or install SuperSU to fix"; exit; fi
}

######### CHECK FOR /.ssh/ folder ############
f_sshcheck(){
if [ -d /.ssh ]; then
    echo "Found /.ssh"
else
    echo "Creating folder /.ssh"
    mount -o rw,remount -t yaffs2 /dev/block/mtdblock3 /
    mkdir .ssh
fi
}

######### CHECK FOR SSH KEYS, CREAT IF NOT FOUND ############
f_sshkeys(){
if [ -e /data/local/kali-armhf/root/.ssh/id_rsa]; then
	echo "SSH keys found"
else
	echo "Generating ssh keys to connect to localhost chroot"
	echo "Location should be /root/.ssh/id_rsa with new password"
	chroot /data/local/kali-armhf "ssh-keygen -t rsa"
fi
}

######### LOAD KALI CHROOT WITH SSH ############
f_boot(){
if [[ $(ssh -q -o "BatchMode=yes" -i /data/local/kali-armhf/root/.ssh/id_rsa localhost echo ok 2>&1) != 'ok' ]]; then
	mount -o remount,rw -t yaffs2 /dev/block/mtdblock3 /system
	export bin=/system/bin
	export mnt=/data/local/kali-armhf
	PRESERVED_PATH=$PATH
	export PATH=/usr/bin:/usr/sbin:/bin:/usr/local/bin:/usr/local/sbin:$PATH
	export TERM=xterm-256color
	export HOME=/root
	export LOGNAME=root

	# MOUNT NECESSARY FOLDERS #

	mount -o bind /system $mnt/system
	mount -o bind /sdcard $mnt/sdcard
	mount -o bind /dev $mnt/dev
	mount -t devpts devpts $mnt/dev/pts
	mount -t proc proc $mnt/proc
	mount -t sysfs sysfs $mnt/sys

	# SET 250MB TO ALLOW POSTGRESQL #
	sysctl -w kernel.shmmax=268435456

	# NETWORK SETTINGS #
	sysctl -w net.ipv4.ip_forward=1

	echo "nameserver 8.8.8.8" > $mnt/etc/resolv.conf
	echo "nameserver 8.8.4.4" >> $mnt/etc/resolv.conf
	echo "127.0.0.1 localhost" > $mnt/etc/hosts

	# execute startup script
	echo "Starting SSH server..."
	chroot $mnt /etc/init.d/ssh start
	ssh -i /data/local/kali-armhf/root/.ssh/id_rsa localhost

else
	ssh -i /data/local/kali-armhf/root/.ssh/id_rsa localhost
	fi
}
#########################
f_checkroot
f_sshkeys
f_sshcheck
f_boot